name: Build binaries and release
on:
  push:
    tags:
      - "v*"
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      VERSION_STRING: ${{ github.ref_name }}
      REPO_URL: github.com/CrispDeserving/github-actions-test
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ">=1.25"
      - run: go version
      - name: Get Package Dependencies
        run: |
          go get -u .
          go mod tidy
      - name: Build For Linux
        run: |
          GOOS="linux" GOARCH="amd64" \
            go build -v -o "dihdah-${GOOS}_${GOARCH}" \
            -ldflags="-X ${REPO_URL}/cmd.versionString=${VERSION_STRING}" \
            .
      - name: Build For MacOS
        run: |
          GOOS="darwin" GOARCH="amd64" \
            go build -v -o "dihdah-${GOOS}_${GOARCH}" \
            -ldflags="-X ${REPO_URL}/cmd.versionString=${VERSION_STRING}" \
            .
      - name: Build For Windows
        run: |
          GOOS="windows" GOARCH="amd64" \
            go build -v -o "dihdah-${GOOS}_${GOARCH}.exe" \
            -ldflags="-X ${REPO_URL}/cmd.versionString=${VERSION_STRING}" \
            .
      - name: Release to Github
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: true
          make_latest: true
          name: Release ${{ github.event.release.tag_name }}
          files: |
            dihdah-*
